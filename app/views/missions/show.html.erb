<div class="p-8">
  <div class="mb-6">
    <%= link_to missions_path, class: "font-mono text-xs text-slate-500 hover:text-slate-300" do %>
      ‚Üê Back to Missions
    <% end %>
  </div>

  <!-- Mission Header -->
  <div class="bg-slate-900 border border-slate-700 rounded-lg p-6 mb-6">
    <div class="flex items-start justify-between mb-4">
      <div>
        <div class="flex items-center gap-3 mb-1">
          <span class="font-mono text-xs uppercase tracking-widest text-slate-500"><%= @mission.domain.name %></span>
          <% if @mission.grade.present? %>
            <span class="font-mono text-xs px-2 py-0.5 rounded <%= grade_color(@mission.grade) %>">
              Grade <%= @mission.grade %>
            </span>
          <% end %>
        </div>
        <h1 class="font-mono text-2xl text-slate-100 mt-1"><%= @mission.title %></h1>
      </div>
      <div class="flex items-center gap-2">
        <% if @mission.status == "standby" %>
          <%= link_to "Edit", edit_mission_path(@mission), class: "font-mono text-xs text-slate-400 hover:text-white px-3 py-1 border border-slate-700 rounded hover:border-slate-500 transition-colors" %>
          <div data-controller="confirm">
            <%= button_to mission_path(@mission), method: :delete,
                data: { action: "click->confirm#open" },
                class: "font-mono text-xs text-red-400 hover:text-red-300 px-3 py-1 border border-red-900 rounded hover:border-red-700 transition-colors" do %>
              Delete
            <% end %>
            <%= render "shared/confirm_modal" %>
          </div>
        <% end %>
      </div>
    </div>

    <p class="text-slate-400 mb-4"><%= @mission.description %></p>

    <!-- Status Bar -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4 text-xs font-mono">
        <span class="px-2 py-1 rounded <%= status_color(@mission.status) %>">
          <%= @mission.status&.upcase || 'STANDBY' %>
        </span>
        <span class="text-slate-500">
          <%= @mission.completion_percentage %>% complete
        </span>
        <span class="text-slate-500">
          <%= @mission.total_xp %> XP potential
        </span>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center gap-2">
        <% if @mission.status == "standby" %>
          <%= button_to commence_mission_path(@mission), method: :post,
              class: "bg-emerald-600 hover:bg-emerald-500 text-white font-mono text-xs px-4 py-2 rounded transition-colors" do %>
            Commence Mission
          <% end %>
        <% elsif @mission.status == "active" %>
          <div data-controller="confirm">
            <%= button_to abort_mission_mission_path(@mission), method: :post,
                data: { action: "click->confirm#open" },
                class: "font-mono text-xs text-amber-400 hover:text-amber-300 px-3 py-1 border border-amber-700 rounded hover:border-amber-500 transition-colors" do %>
              Abort Mission
            <% end %>
            <%= render "shared/abort_modal" %>
          </div>
        <% elsif @mission.status == "completed" %>
          <span class="font-mono text-xs text-emerald-400 px-3 py-1 bg-emerald-400/10 rounded">
            Mission Accomplished
          </span>
        <% elsif @mission.status == "aborted" %>
          <%= button_to commence_mission_path(@mission), method: :post,
              class: "bg-amber-600 hover:bg-amber-500 text-white font-mono text-xs px-4 py-2 rounded transition-colors" do %>
            Resume Mission
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="mt-4">
      <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
        <div class="h-full bg-blue-500 transition-all duration-500" style="width: <%= @mission.completion_percentage %>%"></div>
      </div>
    </div>

    <% if @mission.started_at.present? %>
      <div class="mt-4 text-xs font-mono text-slate-500">
        Started <%= time_ago_in_words(@mission.started_at) %> ago
        <% if @mission.completed_at.present? %>
          ¬∑ Completed <%= time_ago_in_words(@mission.completed_at) %> ago
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Objectives Section -->
  <div class="bg-slate-900 border border-slate-700 rounded-lg p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-mono text-xs uppercase tracking-widest text-slate-500">Objectives</h2>
      <span class="font-mono text-xs text-slate-500">
        <%= @mission.objectives.completed.count %>/<%= @mission.objectives.count %> complete
      </span>
    </div>

    <% if @objectives.any? %>
      <div class="space-y-2">
        <% @objectives.each do |objective| %>
          <div class="flex items-center gap-3 p-4 bg-slate-800 rounded group <%= objective.status == 'active' ? 'border border-blue-500/50' : '' %>">
            <!-- Status Indicator / Action Button -->
            <% if objective.completed? %>
              <% if %w[active completed].include?(@mission.status) %>
                <%= button_to toggle_mission_objective_path(@mission, objective), method: :post,
                    class: "w-7 h-7 rounded-full border-2 border-emerald-500 bg-emerald-500/20 flex items-center justify-center text-emerald-400 text-sm flex-shrink-0 cursor-pointer hover:bg-emerald-500/40 transition-colors" do %>
                  ‚úì
                <% end %>
              <% else %>
                <span class="w-7 h-7 rounded-full border-2 border-emerald-500 bg-emerald-500/20 flex items-center justify-center text-emerald-400 text-sm flex-shrink-0">‚úì</span>
              <% end %>
            <% elsif objective.status == "active" %>
              <% if @mission.status == "active" %>
                <%= button_to toggle_mission_objective_path(@mission, objective), method: :post,
                    class: "w-7 h-7 rounded-full border-2 border-blue-500 bg-blue-500/20 flex items-center justify-center transition-colors flex-shrink-0 cursor-pointer hover:bg-blue-500/40 animate-pulse" do %>
                  <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                <% end %>
              <% else %>
                <span class="w-7 h-7 rounded-full border-2 border-blue-500 bg-blue-500/20 flex items-center justify-center flex-shrink-0">
                  <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                </span>
              <% end %>
            <% else %>
              <% if @mission.status == "active" %>
                <%= button_to toggle_mission_objective_path(@mission, objective), method: :post,
                    class: "w-7 h-7 rounded-full border-2 border-slate-600 hover:border-blue-500 hover:bg-blue-500/10 flex items-center justify-center transition-colors flex-shrink-0 cursor-pointer" do %>
                <% end %>
              <% else %>
                <span class="w-7 h-7 rounded-full border-2 border-slate-600 flex-shrink-0"></span>
              <% end %>
            <% end %>

            <!-- Objective Details -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="text-slate-300 <%= objective.completed? ? 'line-through text-slate-500' : '' %>">
                  <%= objective.description %>
                </span>
                <!-- Status Badge -->
                <span class="font-mono text-xs px-2 py-0.5 rounded <%= objective_status_color(objective.status) %>">
                  <%= objective.status&.upcase || 'PENDING' %>
                </span>
              </div>
              <% if objective.skill_name.present? %>
                <span class="block text-xs text-slate-500 mt-1">
                  Skill: <%= objective.skill_name %>
                </span>
              <% end %>
              <% if objective.started_at.present? && !objective.completed? %>
                <span class="block text-xs text-slate-600 mt-1">
                  Started <%= time_ago_in_words(objective.started_at) %> ago
                </span>
              <% end %>
            </div>

            <!-- XP and Actions -->
            <div class="flex items-center gap-3 text-xs font-mono">
              <span class="text-slate-500">Lv.<%= objective.difficulty %></span>
              <span class="<%= objective.completed? ? 'text-emerald-400' : 'text-slate-500' %>">
                +<%= objective.xp_reward %> XP
              </span>
              <% if @mission.status == "standby" %>
                <%= button_to mission_objective_path(@mission, objective), method: :delete,
                    data: { turbo_confirm: "Remove this objective?" },
                    class: "text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity" do %>
                  ‚úï
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Legend -->
      <div class="mt-4 pt-4 border-t border-slate-700 flex items-center gap-6 text-xs text-slate-500">
        <div class="flex items-center gap-2">
          <span class="w-4 h-4 rounded-full border-2 border-slate-600"></span>
          <span>Pending</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-4 h-4 rounded-full border-2 border-blue-500 bg-blue-500/20 flex items-center justify-center">
            <span class="w-1 h-1 rounded-full bg-blue-400"></span>
          </span>
          <span>In Progress</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-4 h-4 rounded-full border-2 border-emerald-500 bg-emerald-500/20 flex items-center justify-center text-emerald-400 text-[8px]">‚úì</span>
          <span>Completed</span>
        </div>
      </div>
    <% else %>
      <p class="text-slate-500 font-mono text-sm">No objectives yet. Add objectives below to get started.</p>
    <% end %>

    <!-- Add Objective Form (for standby and active missions) -->
    <% if %w[standby active].include?(@mission.status) %>
      <div class="mt-6 pt-6 border-t border-slate-700">
        <h3 class="font-mono text-xs uppercase tracking-widest text-slate-500 mb-4">Add Objective</h3>
        <%= form_with model: [@mission, Objective.new], class: "space-y-4" do |f| %>
          <div class="flex gap-4">
            <div class="flex-1">
              <%= f.text_field :description,
                  placeholder: "What needs to be done?",
                  class: "w-full bg-slate-800 border border-slate-700 rounded px-4 py-2 text-slate-100 font-mono text-sm focus:outline-none focus:border-blue-500" %>
            </div>
            <div class="w-32">
              <%= f.select :difficulty,
                  [["Lv.1 (25 XP)", 1], ["Lv.2 (50 XP)", 2], ["Lv.3 (75 XP)", 3], ["Lv.4 (100 XP)", 4]],
                  {},
                  class: "w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-slate-100 font-mono text-sm focus:outline-none focus:border-blue-500" %>
            </div>
          </div>
          <div class="flex gap-4">
            <div class="flex-1">
              <%= f.text_field :skill_name,
                  placeholder: "Skill gained (optional)",
                  class: "w-full bg-slate-800 border border-slate-700 rounded px-4 py-2 text-slate-100 font-mono text-sm focus:outline-none focus:border-blue-500" %>
            </div>
            <%= f.submit "Add Objective",
                class: "bg-slate-700 hover:bg-slate-600 text-white font-mono text-sm px-4 py-2 rounded transition-colors cursor-pointer" %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Mission Badge (if completed) -->
  <% if @mission.status == "completed" && @mission.badge.present? %>
    <div class="bg-slate-900 border border-emerald-700 rounded-lg p-6 text-center">
      <div class="w-16 h-16 mx-auto mb-4 bg-emerald-500/20 rounded-full flex items-center justify-center">
        <span class="text-3xl"><%= @mission.badge.icon || "üèÜ" %></span>
      </div>
      <h3 class="font-mono text-lg text-emerald-400 mb-2">Badge Earned</h3>
      <p class="font-mono text-slate-100"><%= @mission.badge.name %></p>
      <p class="text-slate-400 text-sm mt-1"><%= @mission.badge.description %></p>
    </div>
  <% end %>
</div>
